<!-- HTML header for doxygen 1.9.0-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ISAAC: Panorama coverage planning</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link rel="icon" href="favicon.png" type="image/png" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="freeflyer.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 70px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ISAAC
   &#160;<span id="projectnumber">0.2.7</span>
   </div>
   <div id="projectbrief">Flight software for the ISAAC project, adding functionality to the Astrobee robot, operating inside the International Space Station.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('pano_coverage.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Panorama coverage planning </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>A panorama coverage plan is a sequence of image center pan/tilt values. The objective of panorama coverage planning is to generate a plan that completely covers the specified range of pan/tilt values with sufficient image-to-image overlap to permit downstream processing (e.g., Hugin panorama stitching), and is sufficiently robust to attitude error. Within those constraints, we want to optimize the plan for minimum image count, as a proxy for minimum run time.</p>
<h1><a class="anchor" id="autotoc_md58"></a>
Relevant files</h1>
<ul>
<li><a href="./scripts/pano_orientations.py">pano_orientations.py</a>: This was the initial reference implementation of a panorama planner. It has been superseded by improvements in the C++ code and may eventually go away.</li>
<li><a href="./src/pano.cc">pano.cc</a>: The latest C++ implementation of the coverage planner.</li>
<li><a href="./tools/test_pano.cc">test_pano.cc</a>: A tool that invokes the coverage planner on the specified test cases.</li>
<li><a href="./scripts/pano_test_cases.csv">pano_test_cases.csv</a>: The test cases used by <code>test_pano.cc</code>.</li>
<li><a href="./scripts/plot_pano.py">plot_pano.py</a>: A script that checks the output of the <code>test_pano</code> tool and produces plots for debugging.</li>
<li><a href="./scripts/field_of_view_calculator.py">field_of_view_calculator.py</a>: A script to calculate the field of view for various Astrobee cameras.</li>
</ul>
<h1><a class="anchor" id="autotoc_md59"></a>
Panorama design approach</h1>
<p>Panorama planning starts from the concept of a rectangular grid of image centers, evenly spaced so as to completely cover the specified (rectangular) imaging area with the desired overlap and attitude tolerance.</p>
<p>The collection order of images in the grid follows a column-major raster pattern: alternating columns are collected top-to-bottom and bottom-to-top. Column-major is preferred because it makes it easier for crew to stay behind the robot during panorama collection, if they care to do so. Following an alternating raster pattern minimizes large attitude changes that are challenging for Astrobee localization.</p>
<p>A further consideration is that, when viewing a plot of the coverage using a typical equirectangular projection, the rectangular area of each image becomes increasingly warped as the tilt value approaches the poles at +/-90 degrees (Fig. 1).</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter"><img src="plot_3_one_column_borders.png" alt="" class="inline" title="Image warping"/>       </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">Figure 1: Image warping. Note that the red image FOV farther from tilt=0 is more warped than the green image FOV.   </td></tr>
</table>
<p>The primary effect of the warping is to make the effective image coverage wider near the poles. We take advantage of this effect by reducing the number of images in grid rows near the poles. A downside of reducing the image count is that the images no longer form a grid, so the column-major raster sequencing is only approximate (Fig. 2).</p>
<p>A secondary effect of the warping is that it complicates determining how to position the warped rectangles of individual image coverage so that together they cover the boundaries of the rectangular desired imaging area. As a result, although the panorama planner's simple heuristic image spacing algorithm tries to meet the coverage and overlap requirements, it can <em>not</em> guarantee they are satisfied in general. Instead, you are encouraged to use the <code>test_pano</code> tool and <code>plot_pano.py</code> script together to check correctness, and if there is a problem, inflate the <code>plan_attitude_tolerance_degrees</code> parameter (used by the <code>test_pano</code> tool at planning time) while leaving unchanged the <code>test_attitude_tolerance_degrees</code> parameter (used by the <code>plot_pano.py</code> tool at testing time), until the problem is corrected.</p>
<h1><a class="anchor" id="autotoc_md60"></a>
ISAAC panorama survey parameters</h1>
<p>There are different styles of panorama that could be useful for different applications.</p>
<h2><a class="anchor" id="autotoc_md61"></a>
&lt;tt&gt;5_mapper_and_hugin&lt;/tt&gt;</h2>
<p>The parameters in this test case are recommended as a potential "workhorse" panorama type for doing complete module surveys. The design criteria were:</p>
<ol type="1">
<li>Capture a panorama with complete spherical coverage.</li>
<li>Tolerate up to 5 degrees (TBC) of attitude error without violating complete coverage or overlap requirements. We don't yet have a good estimate of actual attitude error during panorama collection.</li>
<li>Enable Hugin auto-stitch of a SciCam panorama. This requires complete SciCam coverage with at least 30% overlap. This is the strictest spacing criterion that ends up driving the panorama plan.</li>
<li>Enable post-activity bundle adjustment for localization. This requires complete NavCam coverage with sufficient overlap. At least 75-80% overlap is needed between consecutive NavCam images in time sequence, but because the NavCam images are recorded continuously at ~5 Hz, as long as the robot angular velocity is low enough, this requirement will always be met regardless of the panorama plan. It also helps to have &gt; ~30% overlap between adjacent columns of the panorama, which is not difficult because the NavCam FOV is so wide. [Not the strictest/driving requirement.]</li>
<li>Enable ISAAC geometry mapper dense mapping to produce a 3D mesh with SciCam texture. This requires both the NavCam bundle adjustment listed above for registration, as well as complete SciCam and HazCam coverage, but without a requirement for them to overlap. [Not the strictest/driving requirement.]</li>
</ol>
<p>As of this writing (2022/02), using the experimental <code>pano_orientations2()</code> planner, the resulting panorama plan has 56 images in 7 rows, with at most 10 images in a row (Fig. 2).</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter"><img src="plot_5_mapper_and_hugin_seq.png" alt="" class="inline" title="5_mapper_and_hugin sequence"/>       </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">Figure 2: <code>5_mapper_and_hugin</code> sequence   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md62"></a>
&lt;tt&gt;4_mapper&lt;/tt&gt;</h2>
<p>This test case examines the scenario of relaxing the Hugin auto-stitch requirement #2 above. In that case, requirement #5 becomes the driving requirement. Because the panorama motion is vertical and HazCam images are acquired continuously at ~5 Hz, the HazCam vertical spacing is not a driving constraint, even though the HazCam has a smaller FOV than the SciCam. As a result, we specify the VFOV from the SciCam, the HFOV from the the HazCam, and as a bit of a hack, we pad the tilt radius slightly to make doubly sure the HazCam gets complete coverage near the poles, despite its smaller VFOV.</p>
<p>The resulting panorama plan has far fewer images than <code>5_mapper_and_hugin</code>, 30 vs. 56, which is attractive. The downsides are that it may not be compatible with Hugin auto-stitch (although it may be feasible to pass pan/tilt parameters from NavCam bundle adjustment to Hugin instead), and probably more importantly, it would be less robust to excessive robot pointing error. If time permits, it might be useful to try to capture a panorama in this more aggressive mode to evaluate whether the data is sufficient for downstream analysis.</p>
<h2><a class="anchor" id="autotoc_md63"></a>
&lt;tt&gt;6_nav_hugin&lt;/tt&gt;</h2>
<p>This test case examines the scenario of relaxing both requirements #2 and #5 above, so that the NavCam overlap requirement #4 becomes the driving requirement. HazCam and SciCam coverage would be incomplete, so the geometry mapper could not build a full 3D mesh, but the resulting NavCam imagery could be used to build a low-resolution NavCam panorama with Hugin auto-stitch.</p>
<p>The resulting panorama plan has only 15 images. This type of panorama could occasionally be suitable for a fast low-resolution survey.</p>
<h1><a class="anchor" id="autotoc_md64"></a>
Validation</h1>
<p>The following shell commands can be used to validate the panorama planner on the test cases:</p>
<div class="fragment"><div class="line">ISAAC_DIR=&quot;$HOME/isaac&quot;</div>
<div class="line">cd &quot;$ISAAC_DIR/src/astrobee/behaviors/inspection/scripts&quot;</div>
<div class="line">$ISAAC_DIR/devel/lib/inspection/test_pano 2  # pano_orientations2() planner</div>
<div class="line">./plot_pano.py -v</div>
</div><!-- fragment --><p>Panorama plans must pass the following checks:</p>
<ul>
<li>Complete coverage. A grid of test points are sampled from the full spherical coverage (currently at 5 degree spacing). Each sampled test point must be within the FOV of at least one image in the panorama. (This testing approach is likely to catch coverage gaps, but can't provide a guarantee for gaps sized smaller than the grid spacing.)</li>
<li>Sufficient overlap. Each image must have the required overlap proportion with its immediate neighbors in the image grid, in all four cardinal directions. Because columns don't necessarily align, there may be two bracketing "immediate neighbors" in each of the north/south directions, and the requirement is that the <em>total</em> overlap over both neighbors must meet the specified overlap proportion. The overlap proportion is estimated by sampling a test grid within the first image and checking how many of the points fall within the neighbor image.</li>
<li>Attitude tolerance. An attitude tolerance requirement of <em>a</em> is factored into the checks by (1) shrinking each image FOV by <em>a</em>/2 on all sides, and (2) also padding the required coverage area by <em>a</em>/2 on all sides.</li>
</ul>
<p>As of this writing, all test cases in <code>pano_test_cases.csv</code> pass with the <code>pano_orientations2()</code> planner.</p>
<p>During the validation process, <code>plot_pano.py</code> also writes several plots for each test case that can be used to visualize the resulting panorama plan.</p>
<h1><a class="anchor" id="autotoc_md65"></a>
Camera field of view estimation</h1>
<p>Modeling the field of view of a camera is complicated. The Astrobee cameras of interest for panorama planning each have a rectangular sensor and a lens with radial distortion. As a result, when the shape of the camera FOV is displayed in a standard equirectangular projection, even at tilt = 0, the FOV shape is not actually a rectangle, but instead has a curved shape with "spikes at the corners". For the purposes of panorama planning, the radial distortion effect is very significant for the NavCam, somewhat significant for the HazCam, and almost negligible for the SciCam.</p>
<p>The true camera FOV shape is both complicated to calculate and difficult to use for panorama planning purposes. As a result, our tools model the FOV as a simplified rectangle. In particular, the rectangle dimensions we use, as output by <code>field_of_view_calculator.py</code>, are an estimate of the inscribed rectangle, i.e., the largest (axis-aligned) rectangle that fits completely within the true FOV shape. This rectangular approximate FOV is currently used both during panorama planning and validation. This is a conservative approach in that it will underestimate the true coverage and overlap in the panorama.</p>
<p>Note that when camera FOV is reported elsewhere, such as in manufacturer technical specifications, it may not agree with our dimensions in part because they may use a different definition, such as the dimensions of the circumscribing rectangle.</p>
<p>Our FOV estimates are based on the calibrated camera intrinsics for Bumble, as documented within the script. We expect that the FOV variation between robots is not large enough to affect panorama planning.</p>
<p>Future improvements in this area could be:</p>
<ul>
<li>Reimplement <code>field_of_view_calculator.py</code> in C++ using exactly the same computer vision libraries used by Astrobee FSW, instead of the current approach based on reimplementing some of the mathematical formulas in simplified form. This would reduce the likelihood of errors in the FOV estimation.</li>
<li>Make the <code>plot_pano.py</code> script display the true camera FOV shape and use that for validation. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.9.0-->
<!-- start footer part -->
</body>
</html>
